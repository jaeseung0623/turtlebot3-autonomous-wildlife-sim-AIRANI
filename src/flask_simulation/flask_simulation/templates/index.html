<!-- index.html ìˆ˜ì • ì˜ˆì‹œ -->
<!DOCTYPE html>
<html>
<head>
    <title>ROS Control Panel</title>
    <style>
        /* ê¸°ì¡´ ì†ë„ ì˜¤ë²„ë ˆì´ */
        #speed-overlay {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.271);
            color: #ffffff;
            font-size: 70px;
            font-weight: bold;
            padding: 12px 28px;
            border-radius: 15px;
            box-shadow: 0 0 12px rgba(0,0,0,0.5);
            font-family: 'Segoe UI', sans-serif;
        }

        #dist-box{
            position:absolute; right:20px;
            background:rgba(0,0,0,0.271); color:#fff;
            padding:6px 12px; border-radius:8px;
            font-family:monospace; font-size:20px; font-weight:bold;
        }

        /* í˜„ì¬ ì‹œê°„ ìš°ìƒë‹¨ */
        #clock {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 24px;
            font-weight: bold;
            color: #ffffff;
            background-color: rgba(0, 0, 0, 0.271);
            padding: 6px 12px;
            border-radius: 8px;
            font-family: monospace;
        }

        /* MODE í† ê¸€ ë²„íŠ¼ */
        #mode-btn{
            position:absolute; top:20px; left:20px;
            background:#007aff;
            color:#fff; border:none;
            padding:8px 16px; border-radius:6px;
            font-weight:bold; cursor:pointer;
        }

        /* RESET ë²„íŠ¼ */
        #reset-btn{
            position:absolute; top:120px; right:20px;
            background:#dc4636d3;
            color:#fff; border:none;
            padding:6px 12px; border-radius:6px;
            font-weight:bold; cursor:pointer;
        }

        /* ì†ë„ ì¡°ì ˆ ë²„íŠ¼ ì˜ìƒ í•˜ë‹¨ */
        .control-button{
        position: absolute;
        bottom: 20px;
        width: 80px;          /* ì§€ë¦„ */
        height: 80px;
        line-height: 80px;    /* ì„¸ë¡œ ì¤‘ì•™ */
        text-align: center;   /* ê°€ë¡œ ì¤‘ì•™ */
        font-size: 46px;      /* ê¸°í˜¸ í¬ê¸° */
        font-weight: bold;
        background: rgba(0, 0, 0, 0.224);
        color: #fff;
        border: none;
        border-radius: 50%;   /* ì™„ì „í•œ ì› */
        cursor: pointer;
        opacity: 0.9;
        }

        #map-holder{
            position:relative;
            display:inline-block;
            margin-left:12px;          /* ì¹´ë©”ë¼ì™€ ê°„ê²© */
            overflow:hidden;
            width:520px; height:496px; /* â˜… ì§€ë„ì˜ ì‹¤ì œ í¬ê¸° ëª…ì‹œ */
        }

        /* ì§€ë„ ì´ë¯¸ì§€/ìº”ë²„ìŠ¤ëŠ” íŒ¨ë‹ìš© ë ˆì´ì–´ ì•ˆì— ë‘  */
        #map-layer{ position:absolute; left:0; top:0; }
        #map-img, #map-canvas{
            position:absolute; left:0; top:0;
            width:520px; height:496px;
        }

        /* MAP MODE ë²„íŠ¼ (ìš°ìƒë‹¨) */
        #map-mode-btn{
        position:absolute; top:8px; right:8px;
        background:#007aff; color:#fff; border:none;
        padding:4px 10px; border-radius:6px;
        font-size:14px; font-weight:bold; cursor:pointer;
        }

        #decrease-btn { left: 180px; }
        #stop-btn     { left: 50%; transform: translateX(-50%); }
        #increase-btn { right: 180px; }
        /* ì‚´ì§ ì§„í•´ì§€ëŠ” í˜¸ë²„ íš¨ê³¼ */
        .control-button:hover { background: rgba(0, 0, 0, 0.55); }
        #dist-box    { top:75px; }  /* ê·¸ ì•„ë˜ */
    </style>
</head>
<body>
    <!-- <div style="position: relative; display: inline-block;"> -->
    <div style="display:flex;">
        <div style="position:relative;">
        <img src="/video_feed" width="640" height="480">
        <div id="speed-overlay">0</div>
        <div id="clock">--:--:--</div>  <!-- í˜„ì¬ ì‹œê°„ -->
        <div id="dist-box">DIST: ---- m</div>

    <!-- ì†ë„ ì œì–´ ë²„íŠ¼ë“¤ -->
    <button id="decrease-btn" class="control-button">-</button>
    <button id="stop-btn"     class="control-button">ğŸ”´ </button>
    <button id="increase-btn" class="control-button">+</button>
    <button id="mode-btn">MODE: AUTO</button>
    <button id="reset-btn">RESET</button>
        </div>
        <div id="map-holder">
          <div id="map-layer">
            <img id="map-img" src="/static/map.png">
            <canvas id="map-canvas" width="520" height="496"></canvas>
          </div>
          <button id="map-mode-btn">MAP: FIXED</button>
        </div>
    </div>
    <script>
    /* ----------------------  ì „ì—­ ìƒíƒœ ---------------------- */
    let manualMode = false;   // false=AUTO, true=MANUAL
    let speedCmd   = 0.0;     // í˜„ì¬ ìˆ˜ë™ ì†ë„ (m/s)

    /* ---------------- â‘  ê³„ê¸°íŒÂ·ì‹œê³„ ì—…ë°ì´íŠ¸ ---------------- */
    setInterval(() => {
    fetch('/speed')
        .then(r => r.json())
        .then(data => {
            const v = Math.round(data.speed);     // km/h ì •ìˆ˜
            const elem = document.getElementById('speed-overlay');
            elem.innerText = v;
            elem.style.color = (v >= 10) ? '#FF3333' : '#ffffff';
        });
    }, 300);

    setInterval(() => {
    document.getElementById('clock').innerText =
        new Date().toLocaleTimeString();
    }, 1000);

    /* ---------------- â‘¡ MODE í† ê¸€ ---------------- */
    function refreshModeUI(){
    const btn = document.getElementById('mode-btn');
    if (manualMode){
        btn.innerText = 'MODE: MANUAL';
        btn.style.background = '#007aff';   // íŒŒë‘
    }else{
        btn.innerText = 'MODE: AUTO';
        btn.style.background = 'rgba(0, 0, 0, 0.271)';   // ì§™ì€ íšŒìƒ‰
    }
    }
    document.getElementById('mode-btn').onclick = () => {
    manualMode = !manualMode;
    fetch('/mode', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ mode: manualMode ? 'manual' : 'auto' })
    // }).then(refreshModeUI);
        }).then(()=>{
        refreshModeUI();
        /* â˜… MANUAL ì§„ì… ì§í›„ speedCmd ì´ˆê¸°í™” */
        if(manualMode){
            fetch('/speed')
                .then(r=>r.json())
                .then(d => {      // d.speed ëŠ” km/h
                    speedCmd = d.speed / 100;  // km/h â†’ m/s
                });
        }
    });
    };
    refreshModeUI();

    /* ---------------- â‘¢ ì†ë„ ë²„íŠ¼ í•¸ë“¤ëŸ¬ ---------------- */
    function sendSpeed(){
    fetch('/cmd_vel', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ speed: speedCmd })   // â† ìˆ«ìë§Œ ë³´ëƒ„
    });
    }
    document.getElementById('increase-btn').onclick = () => {
    speedCmd = Math.min(speedCmd + 0.05, 1.5);  // ìƒí•œ 1.5 m/s
    sendSpeed();
    };
    document.getElementById('decrease-btn').onclick = () => {
    speedCmd = Math.max(speedCmd - 0.05, 0.0);
    sendSpeed();
    };
    document.getElementById('stop-btn').onclick = () => {
    speedCmd = 0.0;
    sendSpeed();
    };

        /* ---- ê¸°ì¡´ ëˆ„ì ê±°ë¦¬ UI ---- */
    setInterval(()=>{
        fetch('/stats')
            .then(r=>r.json())
            .then(s=>{
                const m = s.dist;                // ëˆ„ì  ê±°ë¦¬ (m)
                const text = (m >= 1000)
                    ? `DIST: ${(m/1000).toFixed(2)} km`
                    : `DIST: ${m.toFixed(1)} m`;
                document.getElementById('dist-box').innerText = text;
            });
    }, 1000);   /* 1 ì´ˆë§ˆë‹¤ */

    /* ---- RESET ë²„íŠ¼ ---- */
    document.getElementById('reset-btn').onclick = () => {
        fetch('/reset_distance', { method: 'POST' })
            .then(() => {
                document.getElementById('dist-box').innerText = 'DIST: 0.0 m';
            });
    };

    /* (1)  ì§€ë„ íŒŒë¼ë¯¸í„°  ------------------------------------ */
    const MAP_RES_X = 0.00756;      // ê°€ë¡œ m/px
    const MAP_RES_Y = 0.00772;      // ì„¸ë¡œ m/px  (XÂ·Y ë”°ë¡œ ì“°ë©´ ë” ì •í™•)
    const MAP_ORG   = { x:-1.964, y:-1.931 };   // ì™¼ìª½-ì•„ë˜ ì›”ë“œ ì¢Œí‘œ
    const CROP_RADIUS_M = 1.0;


    /* (2)  ìº”ë²„ìŠ¤ ì»¨í…ìŠ¤íŠ¸ ì–»ê¸° ------------------------------ */
    const mcv  = document.getElementById('map-canvas');
    const mctx = mcv.getContext('2d');
    const layer = document.getElementById('map-layer');   // â˜… íŒ¨ë‹ ëŒ€ìƒ
    let vpW = 520, vpH = 496;                           // ë·°í¬íŠ¸ í¬ê¸°

    /* ----------  Map Mode í† ê¸€(FIXED â†” FOLLOW)  ---------- */
    let followMode = false;           // false=FIXED, true=FOLLOW

    function refreshMapModeUI(){
        const btn    = document.getElementById('map-mode-btn');
        const holder = document.getElementById('map-holder');   // ì§€ë„ ì°½

        if (followMode){                 // â”€â”€â”€ FOLLOW â”€â”€â”€
            btn.innerText = 'MAP: FOLLOW';
            btn.style.background = 'rgba(0,0,0,0.271)';

            /* â‘  ë¡œë´‡ ë°˜ê²½(m) â†’ í”½ì…€ */
            const cropW = Math.round((CROP_RADIUS_M * 2) / MAP_RES_X);
            const cropH = Math.round((CROP_RADIUS_M * 2) / MAP_RES_Y);

            /* â‘¡ ì§€ë„ â€˜ì°½â€™ë§Œ ì¶•ì†Œ â†’ ì°½ ë°–ì€ ì˜ë¦¼ */
            holder.style.width  = cropW + 'px';
            holder.style.height = cropH + 'px';

            /* â‘¢ íŒ¨ë‹ ê³„ì‚°ìš© ìµœì‹  ë·°í¬íŠ¸ í¬ê¸° ì €ì¥ */
            vpW = cropW;
            vpH = cropH;

        } else {                         // â”€â”€â”€ FIXED â”€â”€â”€
            btn.innerText = 'MAP: FIXED';
            btn.style.background = '#007aff';

            holder.style.width  = '520px';
            holder.style.height = '496px';

            vpW = 520;
            vpH = 496;
        }
    }

    document.getElementById('map-mode-btn').onclick = ()=>{
        followMode = !followMode;
        refreshMapModeUI();
    };
    refreshMapModeUI();

    /* (3)  ì›”ë“œ â†’ í”½ì…€ ë³€í™˜ --------------------------------- */
    function world2px(wx, wy){
        const px = mcv.width  - (wx - MAP_ORG.x) / MAP_RES_X;
        const py = (wy - MAP_ORG.y) / MAP_RES_Y;
        return [px, py];
    }

    /* (4)  í™”ì‚´í‘œ(ì‚¼ê°í˜•) ê·¸ë¦¬ê¸° ----------------------------- */
    function drawArrow(wx, wy, yaw){
        const [px, py] = world2px(wx, wy);

        /* â‘  FOLLOW ëª¨ë“œë©´ ì§€ë„ ë ˆì´ì–´ë¥¼ íŒ¨ë‹í•´ì„œ ë¡œë´‡ì„ ì¤‘ì•™ ê³ ì • */
        if(followMode){
            const offX = vpW/2 - px;
            const offY = vpH/2 - py;
            layer.style.transform = `translate(${offX}px, ${offY}px)`;
        }else{
            layer.style.transform = 'translate(0px,0px)';  // FIXED
        }

        /* â‘¡ í™”ì‚´í‘œ ìì²´ëŠ” í•­ìƒ ì§€ë„ ì ˆëŒ€ì¢Œí‘œ(px,py)ì— ê·¸ë¦¼ */
        mctx.clearRect(0, 0, mcv.width, mcv.height);
        mctx.save();
        mctx.translate(px, py);
        mctx.rotate(-yaw - Math.PI / 2);       // 90Â° CCW ë³´ì •
        mctx.fillStyle = '#00ff00';
        mctx.beginPath();
        mctx.moveTo(0,-10); mctx.lineTo(-6,8); mctx.lineTo(6,8);
        mctx.closePath(); mctx.fill();
        mctx.restore();
    }

    /* (5)  ì£¼ê¸°ì ìœ¼ë¡œ /pose ë°›ì•„ì„œ ê°±ì‹  ---------------------- */
    setInterval(()=>{
        fetch('/pose')
            .then(r => r.json())
            .then(p => drawArrow(p.x, p.y, p.yaw));
    }, 300);      // 0.3 ì´ˆë§ˆë‹¤
    </script>

</body>
</html>
